<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Parnas Hotel Collection Product Inquiry</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;padding:24px;background:#fafafa;}
    .wrap{max-width:920px;margin:0 auto;background:#fff;border:1px solid #eee;border-radius:12px;padding:20px;}
    h1{margin:0 0 6px;font-size:22px;}
    p.sub{margin:0 0 18px;color:#666;font-size:14px;line-height:1.5;}
    label{display:block;font-size:14px;margin:12px 0 6px;}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:10px;font-size:14px;box-sizing:border-box;}
    textarea{resize:vertical;}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .items{display:flex;flex-direction:column;gap:10px;margin-top:10px;}
    .item{padding:12px;border:1px solid #eee;border-radius:12px;background:#fcfcfc;}
    .row{display:grid;grid-template-columns:1fr 120px 170px 170px 90px;gap:10px;align-items:end;}
    .muted{color:#777;font-size:12px;line-height:1.4;}
    .btns{display:flex;gap:10px;margin-top:12px;}
    button{border:0;border-radius:10px;padding:10px 12px;font-size:14px;cursor:pointer;}
    .btn-add{background:#111;color:#fff;}
    .btn-remove{background:#eee;}
    .summary{margin-top:14px;padding:14px;border:1px solid #eee;border-radius:12px;background:#fff;}
    .summaryRow{display:flex;justify-content:space-between;gap:10px;font-size:14px;padding:6px 0;}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#f1f1f1;font-size:12px;color:#444;}
    .ok{color:#0a7;}
    .bad{color:#c00;}
    .warn{background:#fff8e1;border:1px solid #ffe4a3;padding:12px;border-radius:12px;margin-top:12px;}
    .btn-submit{width:100%;margin-top:16px;background:#0a7;color:#fff;padding:12px;}
    @media (max-width:860px){ .row{grid-template-columns:1fr;} }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Product Inquiry (Overseas)</h1>
    <p class="sub">
      Select products and quantities to request an estimated subtotal in <strong>USD</strong>.
      <br><span class="pill">Shipping is NOT included</span> — shipping fees, duties, and taxes will be quoted and paid separately.
    </p>

    <!-- Netlify Forms -->
    <form name="product-inquiry" method="POST" data-netlify="true" netlify-honeypot="bot-field" action="/thanks/">
      <input type="hidden" name="form-name" value="product-inquiry" data-netlify="true"/>

      <!-- ✅ 메일에 남길 요약 필드들 -->
      <input type="hidden" name="items_count" id="items_count" value="2" />
      <input type="hidden" name="total_qty" id="total_qty" value="0" />

      <!-- ✅ 줄바꿈 잘 보이게 textarea로 -->
      <textarea name="items_summary" id="items_summary" style="display:none;"></textarea>

      <input type="hidden" name="subtotal_krw" id="subtotal_krw" value="0" />
      <input type="hidden" name="subtotal_usd" id="subtotal_usd" value="0" />
      <input type="hidden" name="subtotal_krw_display" id="subtotal_krw_display" value="" />
      <input type="hidden" name="subtotal_usd_display" id="subtotal_usd_display" value="" />

      <!-- Honeypot -->
      <p style="display:none;">
        <label>Don’t fill this out: <input name="bot-field" /></label>
      </p>

      <div class="grid2">
        <div>
          <label>Destination Country</label>
          <select name="country" id="country" required>
            <option value="" disabled selected>Select</option>
            <option value="US">United States</option>
            <option value="HK">Hong Kong</option>
            <option value="JP">Japan</option>
            <option value="SG">Singapore</option>
            <option value="TW">Taiwan</option>
            <option value="CN">China</option>
            <option value="EU">Europe (Other)</option>
            <option value="OTHER">Other</option>
          </select>
          <div class="muted" id="fx_status">Exchange rate (KRW → USD): <span class="pill">loading…</span></div>
        </div>

        <div>
          <label>Contact Email</label>
          <input type="email" name="customer_email" placeholder="name@example.com" required />
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>City / Postal Code (for shipping quote)</label>
          <input type="text" name="shipping_destination" placeholder="e.g., Central / 999077" />
        </div>
        <div>
          <label>Company / Name</label>
          <input type="text" name="customer_name" placeholder="e.g., ABC Trading / John" required />
        </div>
      </div>

      <label>Items</label>
      <div class="muted">Prices are estimates. Final quotation may vary based on availability/options.</div>

      <div class="items" id="items">
        <!-- Item 1 -->
        <div class="item" data-item>
          <div class="row">
            <div>
              <label>Product</label>
              <select name="item_1_product" class="product" required></select>
            </div>
            <div>
              <label>Qty</label>
              <input type="number" name="item_1_qty" class="qty" min="1" step="1" value="1" required />
            </div>
            <div>
              <label>Unit Price (USD)</label>
              <input type="text" class="unit_display" value="—" disabled />
              <input type="hidden" name="item_1_unit_krw" class="unit_krw" value="0" />
            </div>
            <div>
              <label>Line Total (USD)</label>
              <input type="text" class="line_display" value="—" disabled />
              <input type="hidden" name="item_1_line_total_usd" class="line_usd" value="0" />
            </div>
            <div>
              <button type="button" class="btn-remove" data-remove>Remove</button>
            </div>
          </div>
        </div>

        <!-- Item 2 -->
        <div class="item" data-item>
          <div class="row">
            <div>
              <label>Product</label>
              <select name="item_2_product" class="product" required></select>
            </div>
            <div>
              <label>Qty</label>
              <input type="number" name="item_2_qty" class="qty" min="1" step="1" value="1" required />
            </div>
            <div>
              <label>Unit Price (USD)</label>
              <input type="text" class="unit_display" value="—" disabled />
              <input type="hidden" name="item_2_unit_krw" class="unit_krw" value="0" />
            </div>
            <div>
              <label>Line Total (USD)</label>
              <input type="text" class="line_display" value="—" disabled />
              <input type="hidden" name="item_2_line_total_usd" class="line_usd" value="0" />
            </div>
            <div>
              <button type="button" class="btn-remove" data-remove>Remove</button>
            </div>
          </div>
        </div>
      </div>

      <div class="btns">
        <button type="button" class="btn-add" id="addBtn">+ Add item</button>
      </div>

      <div class="summary">
        <div class="summaryRow">
          <span>Subtotal (KRW)</span>
          <strong id="subtotalKRW">₩0</strong>
        </div>
        <div class="summaryRow">
          <span>Estimated Subtotal (USD)</span>
          <strong id="subtotalUSD">—</strong>
        </div>

        <div class="warn">
          <div><strong>Shipping Notice</strong></div>
          <div class="muted">
            Shipping fees, import duties, and taxes are <strong>not included</strong>.
            They will be quoted separately and paid by the customer.
          </div>
          <label style="margin-top:10px;">
            <input type="checkbox" name="shipping_confirm" required style="width:auto;margin-right:8px;">
            I understand shipping/duties/taxes are not included and will be paid separately.
          </label>
        </div>
      </div>

      <label>Additional Notes (optional)</label>
      <textarea name="message" rows="5" placeholder="Size / option / desired delivery time / special requests"></textarea>

      <input type="hidden" name="_meta" value="New product inquiry_oversea" />
      <button type="submit" class="btn-submit">Submit</button>
    </form>
  </div>

  <script>
    // ✅ Product list & KRW prices
    const PRODUCTS = [
      { key: "Goosedown Duvet Set King Size", label: "Goosedown Duvet Set King Size", priceKRW: 1750000 },
      { key: "Goosedown Duvet Set Queen Size", label: "Goosedown Duvet Set Queen Size", priceKRW: 1680000 },
      { key: "Goosedown Duvet Set Single Size", label: "Goosedown Duvet Set Single Size", priceKRW: 1400000 },
      { key: "Premium Goosedown Pillow Set", label: "Premium Goosedown Pillow Set", priceKRW: 460000 },
      { key: "Goosedown Pillow Set King Size", label: "Goosedown Pillow Set King Size", priceKRW: 395000 },
      { key: "Bed Sheet King Size", label: "Bed Sheet King Size", priceKRW: 270000 },
      { key: "Bed Sheet Queen Size", label: "Bed Sheet Queen Size", priceKRW: 250000 },
      { key: "Bed Sheet Single Size", label: "Bed Sheet Single Size", priceKRW: 210000 },
      { key: "Bathrobe", label: "Bathrobe", priceKRW: 185000 },
      { key: "Bath Towel Set(2ea)", label: "Bath Towel Set(2ea)", priceKRW: 115000 },
      { key: "Face Towel Set(3ea)", label: "Face Towel Set(3ea)", priceKRW: 79000 }
    ];

    const form = document.querySelector('form[name="product-inquiry"]');

    const itemsEl = document.getElementById('items');
    const addBtn = document.getElementById('addBtn');
    const fxStatus = document.getElementById('fx_status');

    const subtotalKRWEl = document.getElementById('subtotalKRW');
    const subtotalUSDEl = document.getElementById('subtotalUSD');

    const subtotalKRWHidden = document.getElementById('subtotal_krw');
    const subtotalUSDHidden = document.getElementById('subtotal_usd');
    const subtotalKRWDispHidden = document.getElementById('subtotal_krw_display');
    const subtotalUSDDispHidden = document.getElementById('subtotal_usd_display');

    const totalQtyHidden = document.getElementById('total_qty');
    const itemsCountHidden = document.getElementById('items_count');
    const itemsSummaryTA = document.getElementById('items_summary');

    let fxRate = null; // KRW -> USD

    function formatKRW(n){
      try {
        return new Intl.NumberFormat('ko-KR', { style:'currency', currency:'KRW', maximumFractionDigits:0 }).format(n);
      } catch(e){
        return `₩${Math.round(n).toLocaleString()}`;
      }
    }

    function formatUSD(n){
      // 일반 결제/청구는 보통 소수점 2자리(센트) 기준 반올림
      const rounded = Math.round((n + Number.EPSILON) * 100) / 100;
      try {
        return new Intl.NumberFormat('en-US', { style:'currency', currency:'USD', minimumFractionDigits:2, maximumFractionDigits:2 }).format(rounded);
      } catch(e){
        return `$${rounded.toFixed(2)}`;
      }
    }

    function buildProductOptions(selectEl){
      selectEl.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "Select";
      opt0.disabled = true;
      opt0.selected = true;
      selectEl.appendChild(opt0);

      PRODUCTS.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.key;
        opt.textContent = p.label;
        opt.dataset.priceKrw = String(p.priceKRW);
        selectEl.appendChild(opt);
      });
    }

    function getSelectedPriceKRW(productSelect){
      const opt = productSelect.options[productSelect.selectedIndex];
      const raw = opt?.dataset?.priceKrw;
      const n = Number(raw);
      return Number.isFinite(n) ? n : 0;
    }

    async function fetchFXRateKRWtoUSD(){
      fxStatus.innerHTML = `Exchange rate (KRW → USD): <span class="pill">loading…</span>`;
      try{
        const url = "https://cdn.jsdelivr.net/npm/@fawazahmed0/currency-api@latest/v1/currencies/krw.json";
        const res = await fetch(url, { cache: "no-store" });
        const data = await res.json();
        const rate = Number(data?.krw?.usd);

        if(!Number.isFinite(rate) || rate <= 0) throw new Error("No rate");
        fxRate = rate;
        fxStatus.innerHTML = `Exchange rate (KRW → USD): <span class="pill ok">1 KRW = ${rate} USD</span>`;
      }catch(e){
        fxRate = null;
        fxStatus.innerHTML = `Exchange rate (KRW → USD): <span class="pill bad">unavailable</span> (KRW subtotal still saved)`;
      }
    }

    function renumberNames(){
      const items = Array.from(itemsEl.querySelectorAll('[data-item]'));
      items.forEach((item, idx) => {
        const n = idx + 1;
        item.querySelector('select.product').name = `item_${n}_product`;
        item.querySelector('input.qty').name = `item_${n}_qty`;
        item.querySelector('input.unit_krw').name = `item_${n}_unit_krw`;
        item.querySelector('input.line_usd').name = `item_${n}_line_total_usd`;
      });
      itemsCountHidden.value = String(items.length);
    }

    function computeAndRender(){
      const items = Array.from(itemsEl.querySelectorAll('[data-item]'));

      const customerName = document.querySelector('input[name="customer_name"]').value || "-";
      const country = document.querySelector('select[name="country"]').value || "-";
      const customerEmail = document.querySelector('input[name="customer_email"]').value || "-";

      let subtotalKRW = 0;
      let subtotalUSD = 0;
      let totalQty = 0;
      const lines = [];

      items.forEach((item, idx) => {
        const n = idx + 1;
        const productSel = item.querySelector('select.product');
        const qtyInput = item.querySelector('input.qty');
        const unitDisp = item.querySelector('input.unit_display');
        const lineDisp = item.querySelector('input.line_display');
        const unitKrwH = item.querySelector('input.unit_krw');
        const lineUsdH = item.querySelector('input.line_usd');

        const qty = Math.max(1, Number(qtyInput.value || 1));
        totalQty += qty;

        const unitKRW = getSelectedPriceKRW(productSel);
        const lineKRW = unitKRW * qty;

        subtotalKRW += lineKRW;
        unitKrwH.value = String(unitKRW);

        const p = productSel.value || "(not selected)";
        lines.push(`${n}. ${p} x ${qty}`);

        if(fxRate && Number.isFinite(fxRate)){
          const unitUSD = unitKRW * fxRate;
          const lineUSD = lineKRW * fxRate;

          unitDisp.value = formatUSD(unitUSD);
          lineDisp.value = formatUSD(lineUSD);

          // 저장은 2자리 반올림 숫자
          const lineUSD2 = Math.round((lineUSD + Number.EPSILON) * 100) / 100;
          lineUsdH.value = String(lineUSD2);

          subtotalUSD += lineUSD;
        }else{
          unitDisp.value = "—";
          lineDisp.value = "—";
          lineUsdH.value = "0";
        }
      });

      const subtotalKRWInt = Math.round(subtotalKRW);
      const subtotalUSD2 = (fxRate ? Math.round((subtotalUSD + Number.EPSILON) * 100) / 100 : 0);

      // 화면 표시
      subtotalKRWEl.textContent = formatKRW(subtotalKRWInt);
      subtotalUSDEl.textContent = (fxRate ? formatUSD(subtotalUSD2) : "—");

      // 폼 저장(메일/Netlify submissions)
      subtotalKRWHidden.value = String(subtotalKRWInt);
      subtotalUSDHidden.value = (fxRate ? String(subtotalUSD2) : "0");

      subtotalKRWDispHidden.value = formatKRW(subtotalKRWInt);
      subtotalUSDDispHidden.value = (fxRate ? formatUSD(subtotalUSD2) : "");

      totalQtyHidden.value = String(totalQty);

      // ✅ items_summary (메일에서 보고 싶은 요약)
      const summaryLines = [
        `Customer Name: ${customerName}`,
        `Country: ${country}`,
        `Contact Email: ${customerEmail}`,
        `Items Count: ${items.length}`,
        `Total Qty: ${totalQty}`,
        `Subtotal KRW: ${subtotalKRWDispHidden.value}`,
        `Subtotal USD: ${subtotalUSDDispHidden.value || "N/A"}`,
        `Items: ${lines.join(" / ")}`
      ];
      itemsSummaryTA.value = summaryLines.join("\n");
    }

    function wireItemEvents(item){
      const productSel = item.querySelector('select.product');
      const qtyInput = item.querySelector('input.qty');

      productSel.addEventListener('change', computeAndRender);
      qtyInput.addEventListener('input', computeAndRender);

      const rmBtn = item.querySelector('[data-remove]');
      rmBtn.onclick = () => {
        const all = itemsEl.querySelectorAll('[data-item]');
        if(all.length <= 1) return;
        item.remove();
        renumberNames();
        computeAndRender();
      };
    }

    function initExistingItems(){
      const items = Array.from(itemsEl.querySelectorAll('[data-item]'));
      items.forEach(item => {
        const sel = item.querySelector('select.product');
        buildProductOptions(sel);
        wireItemEvents(item);
      });
      renumberNames();
    }

    function addItem(){
      const first = itemsEl.querySelector('[data-item]');
      const clone = first.cloneNode(true);

      const sel = clone.querySelector('select.product');
      const qty = clone.querySelector('input.qty');

      qty.value = "1";
      buildProductOptions(sel);
      sel.selectedIndex = 0;

      clone.querySelector('input.unit_display').value = "—";
      clone.querySelector('input.line_display').value = "—";
      clone.querySelector('input.unit_krw').value = "0";
      clone.querySelector('input.line_usd').value = "0";

      itemsEl.appendChild(clone);
      wireItemEvents(clone);
      renumberNames();
      computeAndRender();
    }

    addBtn.addEventListener('click', addItem);
    document.querySelector('input[name="customer_name"]').addEventListener('input', computeAndRender);
    document.querySelector('input[name="customer_email"]').addEventListener('input', computeAndRender);
    document.querySelector('select[name="country"]').addEventListener('change', computeAndRender);

    // Submit hook (제출 직전에 최종 값 보장)
    form.addEventListener('submit', () => {
      renumberNames();
      computeAndRender();
    });

    // Init
    initExistingItems();
    (async () => {
      await fetchFXRateKRWtoUSD();
      computeAndRender();
    })();
  </script>
</body>
</html>
